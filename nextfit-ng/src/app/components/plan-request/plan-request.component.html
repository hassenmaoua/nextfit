<p-fluid>
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-8 p-4">
        <!-- Fitness Goals Section -->
        <p-panel [toggleable]="true">
            <ng-template #header>
                <div class="flex items-center gap-2 p-2">
                    <span class="text-xl font-semibold">Fitness Goals</span>
                    <i class="pi pi-question-circle opacity-50 cursor-pointer" [pTooltip]="'This tooltip text is not implemented yet!'" tooltipPosition="right"></i>
                </div>
            </ng-template>

            <div class="grid gap-6 p-2">
                <!-- Primary Goal -->
                <div class="field">
                    <label class="required">Primary Goal</label>
                    <p-selectButton [options]="goalOptions" formControlName="primaryGoal" optionLabel="label" optionValue="value" class="w-full" />
                    <small *ngIf="f['primaryGoal'].errors?.['required'] && f['primaryGoal'].touched" class="p-error">Primary Goal is required</small>
                </div>

                <!-- Target Metrics -->
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="field">
                        <label class="optional" for="targetWeight">Target Weight</label>
                        <p-inputGroup>
                            <p-inputNumber #targetWeight id="targetWeight" formControlName="targetWeight" [min]="20" [max]="999" [showButtons]="true" class="w-full" />
                            <p-inputGroupAddon>KG</p-inputGroupAddon>
                        </p-inputGroup>
                    </div>

                    <div class="field">
                        <label for="timeline">Target Timeline </label>
                        <div class="flex items-center gap-3">
                            <p-inputGroup>
                                <p-inputNumber #timeline id="timeline" formControlName="timelineWeeks" [min]="1" [max]="52" mode="decimal" [showButtons]="true" buttonLayout="horizontal" class="w-full">
                                    <ng-template #incrementbuttonicon>
                                        <span class="pi pi-plus"></span>
                                    </ng-template>
                                    <ng-template #decrementbuttonicon>
                                        <span class="pi pi-minus"></span>
                                    </ng-template>
                                </p-inputNumber>
                                <p-inputGroupAddon>Week</p-inputGroupAddon>
                            </p-inputGroup>
                        </div>
                        <small *ngIf="f['timelineWeeks'].errors?.['required'] && f['timelineWeeks'].touched" class="p-error">Timeline is required</small>
                    </div>

                    <div class="field">
                        <label>Gym Access</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <div class="flex items-center">
                                <p-radioButton id="gymYes" name="hasGymAccess" [value]="true" formControlName="hasGymAccess" />
                                <label for="gymYes" class="ml-2">Yes</label>
                            </div>
                            <div class="flex items-center">
                                <p-radioButton id="gymNo" name="hasGymAccess" [value]="false" formControlName="hasGymAccess" />
                                <label for="gymNo" class="ml-2">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label class="required" for="exerciseTypes">Types of Exercise</label>
                        <p-autoComplete
                            #exerciseTypes
                            id="exerciseTypes"
                            formControlName="exerciseTypes"
                            [multiple]="true"
                            [dropdown]="true"
                            [suggestions]="exerciseSuggestions"
                            (completeMethod)="searchExercises($event)"
                            placeholder="E.g. Running, Weightlifting"
                            class="w-full"
                            [ngClass]="{ 'p-invalid': f['exerciseTypes'].touched && f['exerciseTypes'].errors }"
                        >
                        </p-autoComplete>
                        <small *ngIf="f['exerciseTypes'].errors?.['required'] && f['exerciseTypes'].touched" class="p-error">Please enter at least one exercise type</small>
                    </div>
                    <div class="field">
                        <label class="required" for="exerciseTypes">Exercise Frequency</label>
                        <p-selectButton id="exerciseFrequency" [options]="frequencyOptions" formControlName="exerciseFrequency" optionLabel="label" optionValue="value" class="w-full" />
                        <small *ngIf="f['exerciseFrequency'].errors?.['required'] && f['exerciseFrequency'].touched" class="p-error">Please enter at least one exercice frequency</small>
                    </div>
                </div>

                <!-- Motivation -->
                <div class="field">
                    <label class="optional" for="motivationText">Why is this goal important to you?</label>
                    <textarea pTextarea #motivationText id="motivationText" formControlName="motivationText" rows="3" class="w-full"></textarea>
                </div>
            </div>
        </p-panel>

        <!-- Personal Information Section -->
        <p-panel [toggleable]="true">
            <ng-template #header>
                <div class="flex items-center gap-2 p-2">
                    <span class="text-xl font-semibold">Personal Information</span>
                </div>
            </ng-template>

            <ng-template #icons>
                <p-button icon="pi pi-cog" severity="secondary" rounded text (click)="menu.toggle($event)" />
                <p-menu #menu id="config_menu" [model]="items" [popup]="true" />
            </ng-template>

            <div class="grid gap-6 p-2">
                <!-- Name Row -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label class="required" for="firstName">First Name</label>
                        <input pInputText id="firstName" type="text" formControlName="firstName" placeholder="Enter first name" class="w-full" [ngClass]="{ 'p-invalid': f['firstName'].touched && f['firstName'].errors }" />
                        <small *ngIf="f['firstName'].errors?.['required'] && f['firstName'].touched" class="p-error">First name is required</small>
                    </div>
                    <div class="field">
                        <label class="required" for="lastName">Last Name</label>
                        <input pInputText id="lastName" type="text" formControlName="lastName" placeholder="Enter last name" class="w-full" [ngClass]="{ 'p-invalid': f['lastName'].touched && f['lastName'].errors }" />
                        <small *ngIf="f['lastName'].errors?.['required'] && f['lastName'].touched" class="p-error">Last name is required</small>
                    </div>
                </div>

                <!-- Contact Row -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label class="required" for="email">Email</label>
                        <p-inputGroup>
                            <input pInputText id="email" type="email" formControlName="email" placeholder="your@email.com" class="w-full" [ngClass]="{ 'p-invalid': f['email'].touched && f['email'].errors }" />
                            <p-inputGroupAddon><i class="pi pi-envelope"></i></p-inputGroupAddon>
                        </p-inputGroup>
                        <small *ngIf="f['email'].errors?.['required'] && f['email'].touched" class="p-error">Email is required</small>
                        <small *ngIf="f['email'].errors?.['email'] && f['email'].touched" class="p-error">Please enter a valid email</small>
                    </div>
                    <div class="field">
                        <label class="required" for="phone">Phone Number</label>
                        <p-inputGroup>
                            <input pInputText type="tel" id="phone" formControlName="phone" placeholder="12 345 678" class="w-full" [ngClass]="{ 'p-invalid': f['phone'].touched && f['phone'].errors }" />
                            <p-inputGroupAddon><i class="pi pi-phone"></i></p-inputGroupAddon>
                        </p-inputGroup>
                        <small *ngIf="f['phone'].errors?.['required'] && f['phone'].touched" class="p-error">Phone number is required</small>
                        <small *ngIf="f['phone'].errors?.['minlength'] && f['phone'].touched" class="p-error">Please enter a complete phone number</small>
                    </div>
                </div>

                <!-- Demographics Row -->
                <div class="grid md:grid-cols-4 gap-6">
                    <!-- Age -->
                    <div class="field">
                        <label for="age">Age</label>
                        <p-inputNumber id="age" formControlName="age" [min]="10" [max]="90" mode="decimal" [showButtons]="true" buttonLayout="horizontal" [ngClass]="{ 'p-invalid': f['age'].touched && f['age'].errors }">
                            <ng-template #incrementbuttonicon>
                                <span class="pi pi-plus"></span>
                            </ng-template>
                            <ng-template #decrementbuttonicon>
                                <span class="pi pi-minus"></span>
                            </ng-template>
                        </p-inputNumber>
                        <small *ngIf="f['age'].errors?.['required'] && f['age'].touched" class="p-error">Age is required</small>
                    </div>

                    <!-- Weight -->
                    <div class="field">
                        <label for="weight">Weight</label>
                        <p-inputGroup>
                            <p-inputNumber id="weight" formControlName="weight" [min]="20" [max]="999" [showButtons]="true" class="w-full" [ngClass]="{ 'p-invalid': f['weight'].touched && f['weight'].errors }" />
                            <p-inputGroupAddon>KG</p-inputGroupAddon>
                        </p-inputGroup>
                        <small *ngIf="f['weight'].errors?.['required'] && f['weight'].touched" class="p-error">Weight is required</small>
                    </div>

                    <!-- Height -->
                    <div class="field">
                        <label for="height">Height</label>
                        <p-inputGroup>
                            <p-inputNumber id="height" formControlName="height" [min]="50" [max]="250" [showButtons]="true" class="w-full" [ngClass]="{ 'p-invalid': f['height'].touched && f['height'].errors }" />
                            <p-inputGroupAddon>CM</p-inputGroupAddon>
                        </p-inputGroup>
                        <small *ngIf="f['height'].errors?.['required'] && f['height'].touched" class="p-error">Height is required</small>
                    </div>

                    <!-- Gender -->
                    <div class="field">
                        <label>Gender</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <div class="flex items-center">
                                <p-radioButton id="genderMale" name="gender" value="male" formControlName="gender" />
                                <label for="genderMale" class="ml-2">Male</label>
                            </div>
                            <div class="flex items-center">
                                <p-radioButton id="genderFemale" name="gender" value="female" formControlName="gender" />
                                <label for="genderFemale" class="ml-2">Female</label>
                            </div>
                        </div>
                        <small *ngIf="f['gender'].errors?.['required'] && f['gender'].touched" class="p-error">Gender is required</small>
                    </div>
                </div>

                <div class="field">
                    <label>Current Activity Level</label>
                    <p-selectButton [options]="currentFrequencyOptions" formControlName="currentActivity" optionLabel="label" optionValue="value" class="w-full" />
                    <small *ngIf="f['currentActivity'].errors?.['required'] && f['currentActivity'].touched" class="p-error">Current Exercice Frequency is required</small>
                </div>
            </div>
        </p-panel>

        <!-- Health & Medical Background Section -->
        <p-panel [toggleable]="true">
            <ng-template #header>
                <div class="flex items-center gap-2 p-2">
                    <span class="text-xl font-semibold">Health & Medical Background</span>
                </div>
            </ng-template>

            <div class="grid gap-6 p-2">
                <!-- Medical Conditions -->
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="field">
                        <label>Any medical conditions?</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <div class="flex items-center">
                                <p-radioButton id="medicalYes" name="hasMedicalConditions" [value]="true" formControlName="hasMedicalConditions" />
                                <label for="medicalYes" class="ml-2">Yes</label>
                            </div>
                            <div class="flex items-center">
                                <p-radioButton id="medicalNo" name="hasMedicalConditions" [value]="false" formControlName="hasMedicalConditions" />
                                <label for="medicalNo" class="ml-2">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label for="medicalDetails">If yes, please specify</label>
                        <textarea pTextarea id="medicalDetails" formControlName="medicalDetails" rows="2" class="w-full" [ngClass]="{ 'p-invalid': f['medicalDetails'].touched && f['medicalDetails'].errors && f['hasMedicalConditions'].value }">
                        </textarea>
                        <small *ngIf="form.value.hasMedicalConditions && f['medicalDetails'].errors?.['required'] && f['medicalDetails'].touched" class="p-error">Please specify medical conditions</small>
                    </div>

                    <!-- Injuries -->
                    <div class="field">
                        <label class="optional" for="injuries">Past injuries/surgeries</label>
                        <textarea pTextarea id="injuries" formControlName="injuries" rows="2" class="w-full"></textarea>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Medications -->
                    <div class="field">
                        <label class="required" for="medications">Current medications</label>
                        <p-autoComplete
                            id="medications"
                            formControlName="medications"
                            [multiple]="true"
                            [dropdown]="true"
                            [suggestions]="medicationSuggestions"
                            (completeMethod)="searchMedications($event)"
                            placeholder="Start typing medications"
                            class="w-full"
                            [ngClass]="{ 'p-invalid': f['medications'].touched && f['medications'].errors }"
                        >
                        </p-autoComplete>
                        <small *ngIf="f['medications'].errors?.['required'] && f['medications'].touched" class="p-error">Please enter at least one medication or 'None'</small>
                    </div>

                    <!-- Allergies -->
                    <div class="field">
                        <label class="required" for="allergies">Allergies</label>
                        <p-autoComplete
                            id="allergies"
                            formControlName="allergies"
                            [multiple]="true"
                            [dropdown]="true"
                            [suggestions]="allergySuggestions"
                            (completeMethod)="searchAllergies($event)"
                            placeholder="E.g. Peanuts, Penicillin"
                            class="w-full"
                            [ngClass]="{ 'p-invalid': f['allergies'].touched && f['allergies'].errors }"
                        >
                        </p-autoComplete>
                        <small *ngIf="f['allergies'].errors?.['required'] && f['allergies'].touched" class="p-error">Please enter at least one allergy or 'None'</small>
                    </div>
                </div>
                <!-- Lifestyle -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label>Do you smoke?</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <div class="flex items-center">
                                <p-radioButton id="smokesYes" name="smokes" [value]="true" formControlName="smokes" />
                                <label for="smokesYes" class="ml-2">Yes</label>
                            </div>
                            <div class="flex items-center">
                                <p-radioButton id="smokesNo" name="smokes" [value]="false" formControlName="smokes" />
                                <label for="smokesNo" class="ml-2">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label>Alcohol consumption</label>
                        <p-selectButton [options]="alcoholOptions" formControlName="alcoholConsumption" optionLabel="label" optionValue="value" class="w-full" />
                    </div>
                </div>
            </div>
        </p-panel>

        <!-- Nutrition & Recovery -->
        <p-panel [toggleable]="true">
            <ng-template #header>
                <div class="flex items-center gap-2 p-2">
                    <span class="text-xl font-semibold">Nutrition</span>
                </div>
            </ng-template>

            <div class="grid gap-6 p-2">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="field">
                        <label>Track Food Intake?</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <div class="flex items-center">
                                <p-radioButton id="trackYes" name="tracksFood" [value]="true" formControlName="tracksFood" />
                                <label for="trackYes" class="ml-2">Yes</label>
                            </div>
                            <div class="flex items-center">
                                <p-radioButton id="trackNo" name="tracksFood" [value]="false" formControlName="tracksFood" />
                                <label for="trackNo" class="ml-2">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-6 gap-6">
                    <div class="field">
                        <label for="mealsPerDay">Meals Per Day</label>
                        <p-inputNumber id="mealsPerDay" formControlName="mealsPerDay" [min]="1" [max]="10" [showButtons]="true" class="w-full" />
                        <small *ngIf="f['mealsPerDay'].errors?.['required'] && f['mealsPerDay'].touched" class="p-error">Please specify meals per day</small>
                    </div>

                    <div class="field">
                        <label for="waterIntake">Water Intake (liters/day)</label>
                        <p-inputNumber
                            id="waterIntake"
                            formControlName="waterIntake"
                            [min]="0"
                            [max]="10"
                            [step]="0.5"
                            mode="decimal"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            [ngClass]="{ 'p-invalid': f['waterIntake'].touched && f['waterIntake'].errors }"
                        >
                            <ng-template #incrementbuttonicon>
                                <span class="pi pi-plus"></span>
                            </ng-template>
                            <ng-template #decrementbuttonicon>
                                <span class="pi pi-minus"></span>
                            </ng-template>
                        </p-inputNumber>
                        <small *ngIf="f['waterIntake'].errors?.['required'] && f['waterIntake'].touched" class="p-error">Please specify water intake</small>
                    </div>
                    <div class="field md:col-span-4">
                        <label>Dietary Restrictions</label>
                        <p-multiSelect [options]="dietOptions" formControlName="dietaryRestrictions" optionLabel="label" optionValue="value" placeholder="Select restrictions" class="w-full" />
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2 p-2">
                <span class="text-xl font-semibold">Sleep & Recovery</span>
            </div>

            <div class="grid gap-6 p-2">
                <div class="grid md:grid-cols-8 gap-6">
                    <div class="field md:col-span-2">
                        <label for="sleepHours">Average Sleep (hours/night)</label>
                        <div class="flex flex-col items-center gap-3">
                            <p-inputNumber
                                id="sleepHours"
                                formControlName="sleepHours"
                                [min]="0"
                                [max]="12"
                                [step]="0.5"
                                mode="decimal"
                                [showButtons]="true"
                                buttonLayout="horizontal"
                                [ngClass]="{ 'p-invalid': f['sleepHours'].touched && f['sleepHours'].errors }"
                            >
                                <ng-template #incrementbuttonicon>
                                    <span class="pi pi-plus"></span>
                                </ng-template>
                                <ng-template #decrementbuttonicon>
                                    <span class="pi pi-minus"></span>
                                </ng-template>
                            </p-inputNumber>
                        </div>
                        <small *ngIf="f['sleepHours'].errors?.['required'] && f['sleepHours'].touched" class="p-error">Please specify sleep hours</small>
                    </div>

                    <div class="field md:col-span-6">
                        <label for="recoveryHabits">Recovery Habits</label>
                        <p-autoComplete
                            id="recoveryHabits"
                            formControlName="recoveryHabits"
                            [multiple]="true"
                            [dropdown]="true"
                            [suggestions]="recoverySuggestions"
                            (completeMethod)="searchRecoveryHabits($event)"
                            placeholder="E.g. stretching, ice bath"
                            class="w-full"
                        >
                        </p-autoComplete>
                    </div>
                </div>
                <div class="field">
                    <label for="stressLevel">Stress Level (1-10)</label>
                    <label class="w-full text-center font-semibold" for="stressLevel">{{ f['stressLevel'].value }}</label>
                    <p-slider id="stressLevel" formControlName="stressLevel" [min]="1" [max]="10" class="w-full" />
                </div>
            </div>
        </p-panel>

        <!-- Additional Information Section -->
        <p-panel [toggleable]="true">
            <ng-template #header>
                <div class="flex items-center gap-2 p-2">
                    <span class="text-xl font-semibold">Additional Information</span>
                </div>
            </ng-template>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="field">
                    <label for="exercisePreferences">Exercise Preferences</label>
                    <textarea pTextarea pTooltip="E.g. Bench Press, Squat, Deadlift etc..." tooltipPosition="bottom" id="exercisePreferences" formControlName="exercisePreferences" rows="2" class="w-full" placeholder="What exercises do you enjoy?">
                    </textarea>
                </div>
                <div class="field">
                    <label for="exerciseDislikes">Exercise Dislikes</label>
                    <textarea
                        pTextarea
                        pTooltip="E.g. Planks, Kettlebells Swings, Jumping Jacks etc..."
                        tooltipPosition="bottom"
                        id="exerciseDislikes"
                        formControlName="exerciseDislikes"
                        rows="2"
                        class="w-full"
                        placeholder="What exercises do you avoid?"
                    >
                    </textarea>
                </div>

                <div class="field">
                    <label for="previousExperience">Previous Fitness Experience</label>
                    <textarea pTextarea id="previousExperience" formControlName="previousExperience" rows="2" class="w-full" placeholder="Describe your fitness background"></textarea>
                </div>

                <div class="field">
                    <label for="otherConcerns">Other Concerns/Comments</label>
                    <textarea pTextarea id="otherConcerns" formControlName="otherConcerns" rows="2" class="w-full"></textarea>
                </div>
            </div>
        </p-panel>

        <!-- Form Actions -->
        <div class="flex flex-row-reverse gap-3">
            <p-button label="Generate" icon="pi pi-check" type="submit" [loading]="isLoading$ | async"></p-button>
            <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-outlined" (onClick)="onCancel()"></p-button>
        </div>

        <!-- Form Status -->
        <!-- <div *ngIf="submitted" class="mt-4">
            <p-messages [(value)]="messages" [enableService]="false"></p-messages>
        </div> -->
    </form>
</p-fluid>

<p-toast />
<p-confirmdialog #cd>
    <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
        <div class="flex flex-col items-center p-8 bg-surface-0 dark:bg-surface-900 rounded">
            <div class="rounded-full bg-primary text-primary-contrast inline-flex justify-center items-center h-24 w-24 -mt-20">
                <i class="pi pi-question !text-5xl"></i>
            </div>
            <span class="font-bold text-2xl block mb-2 mt-6">{{ message.header }}</span>
            <p class="mb-0">{{ message.message }}</p>
            <div class="flex items-center gap-2 mt-6">
                <p-button label="Save" (onClick)="onAccept()" styleClass="w-32"></p-button>
                <p-button label="Cancel" [outlined]="true" (onClick)="onReject()" styleClass="w-32"></p-button>
            </div>
        </div>
    </ng-template>
</p-confirmdialog>
